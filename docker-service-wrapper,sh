#!/bin/bash
# Docker service wrapper script for systemd

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Function to cleanup on exit
cleanup() {
    echo "Stopping containers..."
    docker compose down
    exit 0
}

# Set up signal handlers
trap cleanup SIGTERM SIGINT

# Start containers
echo "Starting Docker containers..."
docker compose up -d

# Check if containers started successfully
if [ $? -ne 0 ]; then
    echo "Failed to start containers"
    exit 1
fi

echo "Containers started successfully"

# Keep the script running and monitor containers
while true; do
    # Check if any containers have stopped
    if ! docker compose ps --services --filter "status=running" | grep -q .; then
        echo "Some containers have stopped, restarting..."
        docker compose up -d
    fi
    sleep 30
done